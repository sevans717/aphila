# Secure PostgreSQL Replica Configuration
# Based on primary config with replica-specific settings

# Connection Settings
listen_addresses = '*'
port = 5432
max_connections = 100
superuser_reserved_connections = 3

# SSL Configuration
ssl = on
ssl_cert_file = '/var/lib/postgresql/ssl/server.crt'
ssl_key_file = '/var/lib/postgresql/ssl/server.key'
ssl_ca_file = '/var/lib/postgresql/ssl/ca.crt'
ssl_prefer_server_ciphers = on
ssl_ciphers = 'ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384:ECDHE-ECDSA-CHACHA20-POLY1305:ECDHE-RSA-CHACHA20-POLY1305'

# Memory Configuration (reduced for replica)
shared_buffers = 128MB
effective_cache_size = 512MB
work_mem = 2MB
maintenance_work_mem = 32MB

# Hot Standby Configuration
hot_standby = on
hot_standby_feedback = on
max_standby_archive_delay = 30s
max_standby_streaming_delay = 30s

# Recovery Configuration (for streaming replication)
primary_conninfo = 'host=postgres-primary-secure port=5432 user=replicator password=replication_password_placeholder sslmode=require sslcert=/var/lib/postgresql/ssl/client.crt sslkey=/var/lib/postgresql/ssl/client.key sslrootcert=/var/lib/postgresql/ssl/ca.crt'
primary_slot_name = 'replica_slot'
promote_trigger_file = '/tmp/postgresql.trigger'
recovery_target_timeline = 'latest'

# Logging (same as primary)
log_connections = on
log_disconnections = on
log_hostname = off
log_line_prefix = '%t [%p]: user=%u,db=%d,app=%a,client=%h '
log_statement = 'ddl'
log_min_messages = warning
log_min_error_statement = error
log_min_duration_statement = 1000

# Statistics
shared_preload_libraries = 'pg_stat_statements'
pg_stat_statements.max = 5000
pg_stat_statements.track = all

# Password Encryption
password_encryption = scram-sha-256

# Security
ssl_min_protocol_version = 'TLSv1.2'
ssl_max_protocol_version = 'TLSv1.3'

# Read-only enforcement (additional safety)
default_transaction_read_only = on
